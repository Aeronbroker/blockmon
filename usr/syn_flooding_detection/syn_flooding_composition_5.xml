<!--
Composition for SYN flooding detection with a parallelization of 5 SynCounter blocks.
It has input external gates called raw_packets1, raw_packets2...
It may not be used without connecting at least one of these gates.
-->

<composition id="syn_flooding5" app_id="syn_flood_det">
	<install>
	
		<threadpool id="syn_threads" num_threads="1" >
			<core number="0"/>
		</threadpool>
			
		<block id="syn_synchronizer" type="syn_synchronizer"  sched_type="active" threadpool="syn_threads"> 
			<params>
			    <sketch width="4096" depth="8" />
			</params>
		</block>
			
		<block id="tuple_parser1" type="tuple_parser"> 
			<params>
			</params>
		</block>
	
		<block id="tuple_parser2" type="tuple_parser"> 
			<params>
			</params>
		</block>
	
		<block id="tuple_parser3" type="tuple_parser"> 
			<params>
			</params>
		</block>
	
		<block id="tuple_parser4" type="tuple_parser"> 
			<params>
			</params>
		</block>
	
		<block id="tuple_parser5" type="tuple_parser"> 
			<params>
			</params>
		</block>
		
		<block id="tuple_demux1" type="tuple_demux" > 
			<params>
			  <gate_tcp state="on" />
			  <gate_udp state="off" />
			  <gate_other state="off" />
			</params>
		</block>
		
		<block id="tuple_demux2" type="tuple_demux" > 
			<params>
			  <gate_tcp state="on" />
			  <gate_udp state="off" />
			  <gate_other state="off" />
			</params>
		</block>
		
		<block id="tuple_demux3" type="tuple_demux" > 
			<params>
			  <gate_tcp state="on" />
			  <gate_udp state="off" />
			  <gate_other state="off" />
			</params>
		</block>
		
		<block id="tuple_demux4" type="tuple_demux" > 
			<params>
			  <gate_tcp state="on" />
			  <gate_udp state="off" />
			  <gate_other state="off" />
			</params>
		</block>
		
		<block id="tuple_demux5" type="tuple_demux" > 
			<params>
			  <gate_tcp state="on" />
			  <gate_udp state="off" />
			  <gate_other state="off" />
			</params>
		</block>
		
		<block id="syn_counter1" type="syn_counter"> 
			<params>
			    <export period="500000" />
			</params>
		</block>
		
		<block id="syn_counter2" type="syn_counter"> 
			<params>
			    <export period="500000" />
			</params>
		</block>
		
		<block id="syn_counter3" type="syn_counter"> 
			<params>
			    <export period="500000" />
			</params>
		</block>
		
		<block id="syn_counter4" type="syn_counter"> 
			<params>
			    <export period="500000" />
			</params>
		</block>
		
		<block id="syn_counter5" type="syn_counter"> 
			<params>
			    <export period="500000" />
			</params>
		</block>
		
		<block id="cms_merger" type="cms_merger"> 
			<params>
			    <merge number="5" />
			</params>
		</block>
		
		<block id="syn_flooding_detection" type="syn_flooding_detection"> 
			<params>
			    <cusum threshold="50" offset="10" mean_window="20" />
			</params>
		</block>

		<connection src_block="syn_synchronizer" src_gate="out_sketch_proto" dst_block="syn_counter1" dst_gate="in_sketch_proto" />
		<connection src_block="syn_synchronizer" src_gate="out_sketch_proto" dst_block="syn_counter2" dst_gate="in_sketch_proto" />
		<connection src_block="syn_synchronizer" src_gate="out_sketch_proto" dst_block="syn_counter3" dst_gate="in_sketch_proto" />
		<connection src_block="syn_synchronizer" src_gate="out_sketch_proto" dst_block="syn_counter4" dst_gate="in_sketch_proto" />
		<connection src_block="syn_synchronizer" src_gate="out_sketch_proto" dst_block="syn_counter5" dst_gate="in_sketch_proto" />
		
		<connection src_block="tuple_parser1" src_gate="out_pkt" dst_block="tuple_demux1" dst_gate="in_pkt" />
		<connection src_block="tuple_parser2" src_gate="out_pkt" dst_block="tuple_demux2" dst_gate="in_pkt" />
		<connection src_block="tuple_parser3" src_gate="out_pkt" dst_block="tuple_demux3" dst_gate="in_pkt" />
		<connection src_block="tuple_parser4" src_gate="out_pkt" dst_block="tuple_demux4" dst_gate="in_pkt" />
		<connection src_block="tuple_parser5" src_gate="out_pkt" dst_block="tuple_demux5" dst_gate="in_pkt" />
		
		<connection src_block="tuple_demux1" src_gate="out_pkt_tcp" dst_block="syn_counter1" dst_gate="in_pkt" />
		<connection src_block="tuple_demux2" src_gate="out_pkt_tcp" dst_block="syn_counter2" dst_gate="in_pkt" />
		<connection src_block="tuple_demux3" src_gate="out_pkt_tcp" dst_block="syn_counter3" dst_gate="in_pkt" />
		<connection src_block="tuple_demux4" src_gate="out_pkt_tcp" dst_block="syn_counter4" dst_gate="in_pkt" />
		<connection src_block="tuple_demux5" src_gate="out_pkt_tcp" dst_block="syn_counter5" dst_gate="in_pkt" />
		
		<connection src_block="syn_counter1" src_gate="out_sketch" dst_block="cms_merger" dst_gate="in_sketch" />
		<connection src_block="syn_counter2" src_gate="out_sketch" dst_block="cms_merger" dst_gate="in_sketch" />
		<connection src_block="syn_counter3" src_gate="out_sketch" dst_block="cms_merger" dst_gate="in_sketch" />
		<connection src_block="syn_counter4" src_gate="out_sketch" dst_block="cms_merger" dst_gate="in_sketch" />
		<connection src_block="syn_counter5" src_gate="out_sketch" dst_block="cms_merger" dst_gate="in_sketch" />
		
		<connection src_block="cms_merger" src_gate="out_sketch" dst_block="syn_flooding_detection" dst_gate="in_sketch" />

		<connection src_block="syn_flooding_detection" src_gate="out_alert" dst_block="syn_counter1" dst_gate="in_alert" />
		<connection src_block="syn_flooding_detection" src_gate="out_alert" dst_block="syn_counter2" dst_gate="in_alert" />
		<connection src_block="syn_flooding_detection" src_gate="out_alert" dst_block="syn_counter3" dst_gate="in_alert" />
		<connection src_block="syn_flooding_detection" src_gate="out_alert" dst_block="syn_counter4" dst_gate="in_alert" />
		<connection src_block="syn_flooding_detection" src_gate="out_alert" dst_block="syn_counter5" dst_gate="in_alert" />

        <ext_gate direction="in" block="tuple_parser1" gate="in_pkt" ext_name="raw_packets1" />
        <ext_gate direction="in" block="tuple_parser2" gate="in_pkt" ext_name="raw_packets2" />
        <ext_gate direction="in" block="tuple_parser3" gate="in_pkt" ext_name="raw_packets3" />
        <ext_gate direction="in" block="tuple_parser4" gate="in_pkt" ext_name="raw_packets4" />
        <ext_gate direction="in" block="tuple_parser5" gate="in_pkt" ext_name="raw_packets5" />

	</install>

</composition>